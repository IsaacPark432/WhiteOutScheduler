<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiteout Survival Battle Scheduler</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>

<body>
    <!-- Snowflakes container -->
    <div id="snow-container" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;"></div>

    <div id="root" class="min-h-screen bg-transparent p-4" style="position:relative;z-index:10;"></div>

    <script>
    (function() {
        const snowflakeCount = 50;
        const container = document.getElementById('snow-container');

        for (let i = 0; i < snowflakeCount; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = 'â„';
            flake.style.position = 'absolute';
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.top = Math.random() * 100 + 'vh';
            flake.style.fontSize = Math.random() * 20 + 10 + 'px';
            flake.style.opacity = Math.random() * 0.6 + 0.4;
            flake.style.animation = `fall ${(Math.random() * 15 + 10)}s linear infinite`;
            flake.style.animationDelay = Math.random() * 20 + 's';
            container.appendChild(flake);
        }
    })();
    </script>

    <style>
    body::before {
        content: "";
        position: fixed;
        top:0;
        left:0;
        width:100%;
        height:100%;
        z-index: -1;
        background: linear-gradient(270deg, #1e3a8a, #3b82f6, #6366f1);
        background-size: 600% 600%;
        animation: gradientShift 30s ease infinite, pulse 20s ease-in-out infinite alternate;
    }

    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes pulse {
        0% { filter: brightness(0.8); }
        50% { filter: brightness(1.2); }
        100% { filter: brightness(0.8); }
    }

    @keyframes fall {
        0% { transform: translateY(0) rotate(0deg); }
        100% { transform: translateY(110vh) rotate(360deg); }
    }

    .snowflake {
        pointer-events: none;
        user-select: none;
        font-family: serif;
        color: white;
        white-space: pre;
    }
    </style>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Firebase config for pointing to the correct DB
        const firebaseConfig = {
            apiKey: "AIzaSyBVisGtT6rYxBSa-Rr0ViESpT_s3zk0Qy0",
            authDomain: "whiteoutstatedb.firebaseapp.com",
            databaseURL: "https://whiteoutstatedb-default-rtdb.firebaseio.com/",
            projectId: "whiteoutstatedb",
            storageBucket: "whiteoutstatedb.firebasestorage.app",
            messagingSenderId: "208146474818",
            appId: "1:208146474818:web:746b2dddd20765cb608adb",
            measurementId: "G-MLDN60Z5KW"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Icon Components
        const Banner = ({ size = 24, className = "" }) => (
            <img
                src="icons/alliance.png"
                width={size} 
                height={size} 
                className={className}
                alt="icon" 
                style={{ display: 'block' }}
            />
        );
        
        const Trash2 = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        );
        
        const Clock = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        );
        
        const UserPlus = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <line x1="20" y1="8" x2="20" y2="14"/>
                <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
        );
        
        const Shield = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
        );

        function BattleScheduler() {
            const [positions, setPositions] = useState({});
            const [playerMapping, setPlayerMapping] = useState({});
            const [playerId, setPlayerId] = useState('');
            const [playerName, setPlayerName] = useState('');
            const [selectedDay, setSelectedDay] = useState(1);
            const [adminPassword, setAdminPassword] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [showMappingManager, setShowMappingManager] = useState(false);
            const [isConnected, setIsConnected] = useState(false);
            
            const ADMIN_PASSWORD = 'whiteout7170';
            
            const days = [
                { id: 1, label: 'Day 1 - Construction' },
                { id: 2, label: 'Day 4 - Troops' },
                { id: 3, label: 'Day 5 - Research' }
            ];

            const generateTimeSlots = () => {
                const slots = [];
                for (let hour = 0; hour < 24; hour++) {
                    for (let half = 0; half < 2; half++) {
                        const minutes = half === 0 ? '00' : '30';
                        const hourStr = hour.toString().padStart(2, '0');
                        const endHour = half === 1 ? (hour + 1).toString().padStart(2, '0') : hourStr;
                        const endMin = half === 1 ? '00' : '30';
                        slots.push({
                            id: slots.length + 1,
                            time: `${hourStr}:${minutes} - ${endHour}:${endMin} UTC`
                        });
                    }
                }
                return slots;
            };

            const timeSlots = generateTimeSlots();

            // FIREBASE REAL-TIME LISTENERS
            useEffect(() => {
                // Connection status
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snapshot) => {
                    setIsConnected(snapshot.val() === true);
                });

                // Listen to schedule changes
                const scheduleRef = database.ref('battle-schedule');
                scheduleRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    setPositions(data || {});
                });

                // Listen to player mapping changes
                const mappingRef = database.ref('player-mapping');
                mappingRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    setPlayerMapping(data || {});
                });

                // Cleanup listeners on unmount
                return () => {
                    connectedRef.off();
                    scheduleRef.off();
                    mappingRef.off();
                };
            }, []);

            // Auto-fill name from mapping when player ID changes
            useEffect(() => {
                if (playerId && playerMapping[playerId]) {
                    setPlayerName(playerMapping[playerId]);
                }
            }, [playerId, playerMapping]);

            const addPlayerMapping = () => {
                if (!playerId.trim()) {
                    alert('Please enter a Player ID');
                    return;
                }
                if (!playerName.trim()) {
                    alert('Please enter a Player Name');
                    return;
                }
                
                database.ref(`player-mapping/${playerId.trim()}`).set(playerName.trim())
                    .then(() => {
                        alert('Player mapping saved!');
                    })
                    .catch((error) => {
                        console.error('Error saving mapping:', error);
                        alert('Failed to save mapping');
                    });
            };

           const claimSlot = (day, slotId) => {
    if (!playerId.trim()) {
        alert('Please enter your Player ID first!');
        return;
    }

    const trimmedPlayerId = playerId.trim();

    const alreadyClaimedToday = Object.entries(positions).some(
        ([key, value]) =>
            key.startsWith(`day${day}-`) &&
            value?.playerId === trimmedPlayerId
    );

    if (alreadyClaimedToday) {
        alert('You can only claim ONE slot per day!');
        return;
    }

    const key = `day${day}-slot${slotId}`;

    if (positions[key]) {
        alert('This slot is already claimed!');
        return;
    }

    const slotData = {
        playerId: trimmedPlayerId,
        playerName: playerName.trim() || playerMapping[trimmedPlayerId] || '',
        timestamp: new Date().toLocaleString()
    };

    database.ref(`battle-schedule/${key}`).set(slotData)
        .then(() => {
            if (playerName.trim() && !playerMapping[trimmedPlayerId]) {
                database.ref(`player-mapping/${trimmedPlayerId}`).set(playerName.trim());
            }
        })
        .catch((error) => {
            console.error('Error claiming slot:', error);
            alert('Failed to claim slot');
        });
};

            const releaseSlot = (day, slotId, slotPlayerId) => {
                if (playerId.trim() !== slotPlayerId && !isAdmin) {
                    alert('You can only release your own slots!');
                    return;
                }
                
                const key = `day${day}-slot${slotId}`;
                
                database.ref(`battle-schedule/${key}`).remove()
                    .catch((error) => {
                        console.error('Error releasing slot:', error);
                        alert('Failed to release slot');
                    });
            };

            const clearDay = async (day) => {
                if (!isAdmin) {
                    alert('Only admins can clear entire days!');
                    return;
                }
                
                if (window.confirm(`Clear all slots for Day ${day}? This cannot be undone!`)) {
                    const updates = {};
                    Object.keys(positions).forEach(key => {
                        if (key.startsWith(`day${day}-`)) {
                            updates[`battle-schedule/${key}`] = null;
                        }
                    });
                    
                    database.ref().update(updates)
                        .catch((error) => {
                            console.error('Error clearing day:', error);
                            alert('Failed to clear day');
                        });
                }
            };

            const clearAll = async () => {
                if (!isAdmin) {
                    alert('Only admins can clear all slots!');
                    return;
                }
                
                if (window.confirm('Clear ALL days and slots? This cannot be undone!')) {
                    database.ref('battle-schedule').remove()
                        .catch((error) => {
                            console.error('Error clearing schedule:', error);
                            alert('Failed to clear schedule');
                        });
                }
            };

            const handleAdminLogin = () => {
                if (adminPassword === ADMIN_PASSWORD) {
                    setIsAdmin(true);
                    setShowAdminLogin(false);
                    alert('Admin access granted!');
                } else {
                    alert('Incorrect password!');
                }
            };

            const getFilledSlotsForDay = (day) => {
                return Object.keys(positions).filter(key => key.startsWith(`day${day}-`)).length;
            };

            const getCoveragePercentage = (day) => {
                return Math.round((getFilledSlotsForDay(day) / 48) * 100);
            };

            return (
                <div className="min-h-screen bg-transparent p-4">
                    <div className="max-w-6xl mx-auto">
                        {/* Connection Status Indicator */}
                        <div className={`fixed top-4 right-4 px-3 py-1 rounded-full text-xs font-semibold z-50 ${
                            isConnected 
                                ? 'bg-green-500/80 text-white' 
                                : 'bg-red-500/80 text-white'
                        }`}>
                            {isConnected ? 'ðŸŸ¢ Live' : 'ðŸ”´ Offline'}
                        </div>
                         <div className="mt-6 bg-white/10 backdrop-blur-md rounded-lg p-4 border border-white/20 items-center justify-center">
                            <h3 className="text-white font-semibold mb-2 text-center ">How to Use:</h3>
                            <ul className="text-blue-100 text-sm space-y-1 text-center">
                                <li>1. Enter your Player ID (required) and optionally your name</li>
                                <li>2. Select which day (Day 1, 2, or 3)</li>
                                <li>3. Claim any 30-minute time slot you can cover</li>
                                <li>4. You can only release slots you've claimed yourself</li>
                                <li>5. Updates are synchronized in real-time across all users!</li>
                                <li>6. Admin can manage player mappings and clear schedules</li>
                            </ul>
                            <p className="text-blue-200 text-xs mt-3 italic">
                                Note: All times are in UTC. Changes sync instantly with your team!
                            </p>
                        </div>

                        <div className="bg-white/10 backdrop-blur-md rounded-lg p-6 mb-6 border border-white/20">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                    <Banner size={200} className="text-blue-200" />
                                    <div>
                                        <h1 className="text-5xl font-bold text-white">State 525 SvS Prep Time Slots</h1>
                                        <p className="text-blue-200 text-sm">24-Hour Coverage Schedule (UTC) - Real-time Sync</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    {!isAdmin ? (
                                        <button
                                            onClick={() => setShowAdminLogin(!showAdminLogin)}
                                            className="flex items-center gap-2 px-4 py-2 bg-purple-500/80 hover:bg-purple-600 text-white rounded-lg transition"
                                        >
                                            <Shield size={18} />
                                            Admin
                                        </button>
                                    ) : (
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => setShowMappingManager(!showMappingManager)}
                                                className="flex items-center gap-2 px-4 py-2 bg-green-500/80 hover:bg-green-600 text-white rounded-lg transition"
                                            >
                                                <UserPlus size={18} />
                                                Manage Players
                                            </button>
                                            <button
                                                onClick={clearAll}
                                                className="flex items-center gap-2 px-4 py-2 bg-red-500/80 hover:bg-red-600 text-white rounded-lg transition"
                                            >
                                                <Trash2 size={18} />
                                                Clear All
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {showAdminLogin && !isAdmin && (
                                <div className="mb-4 p-4 bg-purple-500/20 border border-purple-400/50 rounded-lg">
                                    <h3 className="text-white font-semibold mb-2">Admin Login</h3>
                                    <div className="flex gap-2">
                                        <input
                                            type="password"
                                            value={adminPassword}
                                            onChange={(e) => setAdminPassword(e.target.value)}
                                            placeholder="Enter admin password"
                                            className="flex-1 px-4 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                            onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
                                        />
                                        <button
                                            onClick={handleAdminLogin}
                                            className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition"
                                        >
                                            Login
                                        </button>
                                    </div>
                                </div>
                            )}

                            {showMappingManager && isAdmin && (
                                <div className="mb-4 p-4 bg-green-500/20 border border-green-400/50 rounded-lg">
                                    <h3 className="text-white font-semibold mb-2">Player ID to Name Mapping</h3>
                                    <div className="mb-3 max-h-40 overflow-y-auto">
                                        {Object.keys(playerMapping).length === 0 ? (
                                            <p className="text-blue-200 text-sm">No mappings yet</p>
                                        ) : (
                                            <div className="space-y-1">
                                                {Object.entries(playerMapping).map(([id, name]) => (
                                                    <div key={id} className="text-white text-sm bg-white/10 px-3 py-1 rounded">
                                                        <span className="font-semibold">{id}</span> â†’ {name}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            <div className="space-y-3 mb-4">
                                <div className="flex gap-3">
                                    <input
                                        type="text"
                                        value={playerId}
                                        onChange={(e) => setPlayerId(e.target.value)}
                                        placeholder="Player ID (Required)*"
                                        className="flex-1 px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                    />
                                    <input
                                        type="text"
                                        value={playerName}
                                        onChange={(e) => setPlayerName(e.target.value)}
                                        placeholder="Player Name (Optional)"
                                        className="flex-1 px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                    />
                                </div>
                                {isAdmin && (
                                    <button
                                        onClick={addPlayerMapping}
                                        className="w-full px-4 py-2 bg-green-500/80 hover:bg-green-600 text-white rounded-lg transition text-sm"
                                    >
                                        Save Player ID â†’ Name Mapping
                                    </button>
                                )}
                            </div>

                            <div className="flex gap-3">
                                {days.map(day => (
                                    <button
                                        key={day.id}
                                        onClick={() => setSelectedDay(day.id)}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition ${
                                            selectedDay === day.id
                                                ? 'bg-blue-500 text-white'
                                                : 'bg-white/20 text-blue-100 hover:bg-white/30'
                                        }`}
                                    >
                                        <div>{day.label}</div>
                                        <div className="text-sm font-normal">
                                            {getFilledSlotsForDay(day.id)}/48 ({getCoveragePercentage(day.id)}%)
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="bg-white/10 backdrop-blur-md rounded-lg p-4 mb-4 border border-white/20 flex justify-center items-center relative">
                            <div className="flex items-center gap-2 text-blue-100">
                                <Clock size={20} />
                                <span className="font-semibold">Day {selectedDay} Schedule</span>
                                <span className="text-sm">({getCoveragePercentage(selectedDay)}% Coverage)</span>
                            </div>
                            {isAdmin && (
                                <button
                                    onClick={() => clearDay(selectedDay)}
                                    className="px-4 py-2 bg-red-500/60 hover:bg-red-600/80 text-white text-sm rounded-lg transition absolute right-4"
                                >
                                    Clear Day {selectedDay}
                                </button>
                            )}
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            {timeSlots.map((slot) => {
                                const key = `day${selectedDay}-slot${slot.id}`;
                                const claimed = positions[key];
                                
                                return (
                                    <div
                                        key={slot.id}
                                        className={`relative p-3 rounded-lg border-2 transition text-center ${
                                            claimed
                                                ? 'bg-green-500/20 border-green-400/50'
                                                : 'bg-white/10 border-white/30 hover:border-blue-400/50'
                                        }`}
                                    >
                                        <div className="text-xs font-bold text-blue-200 mb-2">
                                            {slot.time}
                                        </div>
                                        
                                        {claimed ? (
                                            <div>
                                                <div className="text-white font-semibold mb-0.5 text-sm break-all">
                                                    {claimed.playerName || claimed.playerId}
                                                </div>
                                                {claimed.playerName && (
                                                    <div className="text-xs text-blue-200 mb-1">
                                                        ID: {claimed.playerId}
                                                    </div>
                                                )}
                                                <button
                                                    onClick={() => releaseSlot(selectedDay, slot.id, claimed.playerId)}
                                                    className="w-full px-3 py-1 bg-red-500/80 hover:bg-red-600 text-white text-xs rounded transition"
                                                >
                                                    Release
                                                </button>
                                            </div>
                                        ) : (
                                            <button
                                                onClick={() => claimSlot(selectedDay, slot.id)}
                                                className="w-full px-3 py-1.5 bg-blue-500/80 hover:bg-blue-600 text-white text-xs font-medium rounded transition"
                                            >
                                                Claim Slot
                                            </button>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<BattleScheduler />, document.getElementById('root'));
    </script>
</body>
</html>